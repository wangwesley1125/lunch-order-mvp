<!DOCTYPE html>
<html lang = "zh-TW">

  <!-- ä¸æœƒé¡¯ç¤ºæ–¼ç¶²é ç€è¦½è€…çœ¼å‰çš„ -->
  <head>
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ± - æŠ•ç¥¨ä¸­</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <!-- æ‰€æœ‰æœƒé¡¯ç¤ºæ–¼ç¶²é ç€è¦½è€…çœ¼å‰çš„å…§å®¹ -->
  <body>

    <!-- Header -->
    <div class = "header">
      <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
      <p>ä½ çš„åˆé¤æ•‘æ˜Ÿ ğŸŒŸ</p>
    </div>

    <!-- Navigation Bar -->
    <div class = "navbar">
      <a href="index.html" class="active">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</a>
      <a href="weekly.html">ğŸ“… æœ¬é€±åƒä»€éº¼</a>
      <a href="restaurants.html">ğŸª ä¾¿ç•¶åº—å®¶</a>
    </div>

    <!-- Main Content -->
    <div class = "main">
      <section class = "vote-section">
        <h2>ğŸ—³ï¸ ä»Šæ—¥åˆé¤æŠ•ç¥¨</h2>
        <p class="vote-info">æŠ•ç¥¨æ™‚é–“ï¼š11:30 - 12:00</p>

        <!-- Google ç™»å…¥å€ -->
        <div id="loginContainer" class="login-container">
          <h3>ğŸ” è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ</h3>
          <p>ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥ä»¥é€²è¡ŒæŠ•ç¥¨</p>
          <button id="google-signin-button">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            ä½¿ç”¨ Google ç™»å…¥
          </button>
        </div>

        <!-- ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º -->
        <div id="userInfo" class="user-info hidden">
          <div class="user-info-left">
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
            <div class="user-details">
              <div class="user-name" id="userName"></div>
              <div class="user-email" id="userEmail"></div>
            </div>
          </div>
          <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
        </div>

        <div class="vote-container" id="voteContainer" style="opacity: 0.5; pointer-events: none;">
          <div class="vote-option" data-restaurant="chishang">
            <img src="https://taiwan.sharelife.tw/tw-feat-store-img/64026/8599051222252813.jpg" alt="æ± ä¸Šä¾¿ç•¶">
            <h3>æ± ä¸Šä¾¿ç•¶</h3>
            <p class="vote-count">å¾—ç¥¨æ•¸ï¼š<span>0</span> ç¥¨</p>
            <button class="vote-button">æŠ•ç¥¨</button>
          </div>

          <div class="vote-option" data-restaurant="bafang">
            <img src="https://www.twec.com.tw/chainstore/%E5%85%AB%E6%96%B9%E9%9B%B2%E9%9B%86/%E5%85%AB%E6%96%B9%E9%9B%B2%E9%9B%861.jpg" alt="å…«æ–¹é›²é›†">
            <h3>å…«æ–¹é›²é›†</h3>
            <p class="vote-count">å¾—ç¥¨æ•¸ï¼š<span>0</span> ç¥¨</p>
            <button class="vote-button">æŠ•ç¥¨</button>
          </div>

          <div class="vote-option" data-restaurant="zhou">
            <img src="https://images.deliveryhero.io/image/fd-tw/Products/2903117.jpg?width=400" alt="å‘¨å¸«çˆ¶">
            <h3>å‘¨å¸«çˆ¶</h3>
            <p class="vote-count">å¾—ç¥¨æ•¸ï¼š<span>0</span> ç¥¨</p>
            <button class="vote-button">æŠ•ç¥¨</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class = "footer">
      <p>ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 åˆé¤é»é¤ç³»çµ±</p>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getDatabase, ref, onValue, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

      // import { firebaseConfig } from './firebase-config.js';
      export const firebaseConfig = {
          apiKey: "AIzaSyAdo-mbq_BQ5tqY4nvscVNtah24Mb8ohmU",
          authDomain: "realtimevote-f8b6d.firebaseapp.com",
          databaseURL: "https://realtimevote-f8b6d-default-rtdb.firebaseio.com/",
          projectId: "realtimevote-f8b6d",
          storageBucket: "realtimevote-f8b6d.firebasestorage.app",
          messagingSenderId: "44615577610",
          appId: "1:44615577610:web:1bf827f2899ae2550d6ff3",
          measurementId: "G-MW1RJZSC0E"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      const today = new Date().toISOString().split('T')[0];
      const votesRef = ref(database, `votes/${today}`);

      let currentUser = null;

      // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // ä½¿ç”¨è€…å·²ç™»å…¥
          currentUser = user;
          showUserInfo(user);
          
          // æª¢æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
          const emailKey = user.email.replace(/[.@]/g, '_');
          const voterSnapshot = await get(ref(database, `voters/${today}/${emailKey}`));
          
          if (voterSnapshot.exists()) {
            const votedRestaurant = voterSnapshot.val();
            showVotedState(votedRestaurant);
          } else {
            // å•Ÿç”¨æŠ•ç¥¨ä»‹é¢
            document.getElementById('voteContainer').style.opacity = '1';
            document.getElementById('voteContainer').style.pointerEvents = 'auto';
          }
        } else {
          // ä½¿ç”¨è€…æœªç™»å…¥
          currentUser = null;
          document.getElementById('loginContainer').classList.remove('hidden');
          document.getElementById('userInfo').classList.add('hidden');
          document.getElementById('voteContainer').style.opacity = '0.5';
          document.getElementById('voteContainer').style.pointerEvents = 'none';
        }
      });

      // Google ç™»å…¥æŒ‰éˆ•
      document.getElementById('google-signin-button').addEventListener('click', async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          
          // æª¢æŸ¥æ˜¯å¦ç‚º Gmail å¸³è™Ÿ
          if (!user.email.endsWith('@gmail.com')) {
            alert('è«‹ä½¿ç”¨ Gmail å¸³è™Ÿç™»å…¥ï¼');
            await signOut(auth);
            return;
          }
          
          console.log('ç™»å…¥æˆåŠŸ:', user.email);
        } catch (error) {
          console.error('ç™»å…¥å¤±æ•—:', error);
          alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        }
      });

      // ç™»å‡ºæŒ‰éˆ•
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          location.reload();
        } catch (error) {
          console.error('ç™»å‡ºå¤±æ•—:', error);
        }
      });

      // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
      function showUserInfo(user) {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('userName').textContent = user.displayName || 'ä½¿ç”¨è€…';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/50';
      }

      // å³æ™‚ç›£è½æŠ•ç¥¨æ•¸è®ŠåŒ–
      onValue(votesRef, (snapshot) => {
        const votes = snapshot.val() || { chishang: 0, bafang: 0, zhou: 0 };
        
        document.querySelectorAll('.vote-option').forEach(option => {
          const restaurant = option.getAttribute('data-restaurant');
          const countSpan = option.querySelector('.vote-count span');
          countSpan.textContent = votes[restaurant] || 0;
        });
      });

      // è™•ç†æŠ•ç¥¨æŒ‰éˆ•é»æ“Š
      document.querySelectorAll('.vote-button').forEach(button => {
        button.addEventListener('click', async (e) => {
          if (!currentUser) {
            alert('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
            return;
          }

          const voteOption = e.target.closest('.vote-option');
          const restaurant = voteOption.getAttribute('data-restaurant');
          const restaurantRef = ref(database, `votes/${today}/${restaurant}`);
          const emailKey = currentUser.email.replace(/[.@]/g, '_');
          const voterRef = ref(database, `voters/${today}/${emailKey}`);

          try {
            // å†æ¬¡ç¢ºèªæ˜¯å¦å·²æŠ•ç¥¨
            const voterSnapshot = await get(voterRef);
            if (voterSnapshot.exists()) {
              alert('æ‚¨å·²ç¶“æŠ•éç¥¨äº†ï¼');
              return;
            }

            // åŸ·è¡ŒæŠ•ç¥¨
            await runTransaction(restaurantRef, (currentVotes) => {
              return (currentVotes || 0) + 1;
            });

            // è¨˜éŒ„æŠ•ç¥¨è€…
            await runTransaction(voterRef, () => {
              return restaurant;
            });

            // é¡¯ç¤ºæŠ•ç¥¨æˆåŠŸ
            showVotedState(restaurant);
            alert('æŠ•ç¥¨æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„åƒèˆ‡ ğŸ˜Š');

          } catch (error) {
            console.error('æŠ•ç¥¨å¤±æ•—ï¼š', error);
            alert('æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        });
      });

      // é¡¯ç¤ºå·²æŠ•ç¥¨ç‹€æ…‹
      function showVotedState(votedRestaurant) {
        document.querySelectorAll('.vote-option').forEach(option => {
          const restaurant = option.getAttribute('data-restaurant');
          const button = option.querySelector('.vote-button');
          
          button.disabled = true;
          
          if (restaurant === votedRestaurant) {
            button.textContent = 'âœ“ å·²æŠ•ç¥¨';
            button.style.backgroundColor = '#28a745';
            option.style.border = '2px solid #28a745';
          } else {
            button.textContent = 'å·²çµæŸ';
            button.style.backgroundColor = '#6c757d';
          }
        });
      }

      // å–å¾—é¤å»³ä¸­æ–‡åç¨±
      function getRestaurantName(key) {
        const names = {
          'chishang': 'æ± ä¸Šä¾¿ç•¶',
          'bafang': 'å…«æ–¹é›²é›†',
          'zhou': 'å‘¨å¸«çˆ¶'
        };
        return names[key] || key;
      }
    </script>

  </body>

</html>