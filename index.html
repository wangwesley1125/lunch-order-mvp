<!DOCTYPE html>
<html lang = "zh-TW">

  <!-- ä¸æœƒé¡¯ç¤ºæ–¼ç¶²é ç€è¦½è€…çœ¼å‰çš„ -->
  <head>
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ± - æŠ•ç¥¨ä¸­</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <!-- æ‰€æœ‰æœƒé¡¯ç¤ºæ–¼ç¶²é ç€è¦½è€…çœ¼å‰çš„å…§å®¹ -->
  <body>

    <!-- Header -->
    <div class = "header">
      <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
      <p>ä½ çš„åˆé¤æ•‘æ˜Ÿ ğŸŒŸ</p>
    </div>

    <!-- Navigation Bar -->
    <div class = "navbar">
      <a href="index.html" class="active">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</a>
      <a href="weekly.html">ğŸ“… æœ¬é€±åƒä»€éº¼</a>
      <a href="restaurants.html">ğŸª ä¾¿ç•¶åº—å®¶</a>
      <a href="add_restaurants.html"> â• æ–°å¢åº—å®¶</a>
    </div>

    <!-- Main Content -->
    <div class = "main">
      <section class = "vote-section">
        <h2>ğŸ—³ï¸ ä»Šæ—¥åˆé¤æŠ•ç¥¨</h2>
        <div class="time-display" id="timeDisplay">
          è¼‰å…¥ä¸­...
        </div>

        <div id="votingClosed" class="voting-closed hidden">
          <h3>â° æŠ•ç¥¨æ™‚é–“å·²çµæŸ</h3>
          <p>ä»Šæ—¥æŠ•ç¥¨å·²ç¶“çµæŸå›‰~</p>
          <p>è«‹æ˜å¤©æ—©ä¸Š 10:30 å‰å†ä¾†æŠ•ç¥¨å“¦ï¼</p>
        </div>

        <div id="loginContainer" class="login-container">
          <h3>ğŸ” è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ</h3>
          <p>ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥ä»¥é€²è¡ŒæŠ•ç¥¨</p>
          <button id="google-signin-button">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            ä½¿ç”¨ Google ç™»å…¥
          </button>
        </div>

        <div id="userInfo" class="user-info hidden">
          <div class="user-info-left">
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
            <div class="user-details">
              <div class="user-name" id="userName"></div>
              <div class="user-email" id="userEmail"></div>
            </div>
          </div>
          <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
        </div>

        <!-- è¼‰å…¥ä¸­è¨Šæ¯ -->
        <div id="loadingRestaurants" class="loading-restaurants">
          <p>è¼‰å…¥åº—å®¶è³‡æ–™ä¸­...</p>
        </div>

        <!-- æ²’æœ‰åº—å®¶æ™‚çš„æç¤º -->
        <div id="noRestaurants" class="no-restaurants hidden">
          <h3>ç›®å‰é‚„æ²’æœ‰ä»»ä½•åº—å®¶å¯ä»¥æŠ•ç¥¨</h3>
          <p>è«‹å…ˆåˆ°ã€Œâ• æ–°å¢åº—å®¶ã€é é¢æ–°å¢åº—å®¶ï¼</p>
        </div>

        <!-- æŠ•ç¥¨é¸é …å®¹å™¨ -->
        <div class="vote-container" id="voteContainer" style="opacity: 0.5; pointer-events: none;">
          <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥åº—å®¶é¸é … -->
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class = "footer">
      <p>ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 åˆé¤é»é¤ç³»çµ±</p>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getDatabase, ref, onValue, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

      // import { firebaseConfig } from './firebase-config.js';
      export const firebaseConfig = {
          apiKey: "AIzaSyAdo-mbq_BQ5tqY4nvscVNtah24Mb8ohmU",
          authDomain: "realtimevote-f8b6d.firebaseapp.com",
          databaseURL: "https://realtimevote-f8b6d-default-rtdb.firebaseio.com/",
          projectId: "realtimevote-f8b6d",
          storageBucket: "realtimevote-f8b6d.firebasestorage.app",
          messagingSenderId: "44615577610",
          appId: "1:44615577610:web:1bf827f2899ae2550d6ff3",
          measurementId: "G-MW1RJZSC0E"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      const today = new Date().toISOString().split('T')[0];
      const votesRef = ref(database, `votes/${today}`);
      const restaurantsRef = ref(database, 'restaurants');
      const weeklyRef = ref(database, 'weekly');

      let currentUser = null;
      let userCurrentVote = null;
      let availableRestaurants = [];
      let votingAllowed = false;

      // æª¢æŸ¥æŠ•ç¥¨æ™‚é–“
      function checkVotingTime() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const currentTime = hours * 60 + minutes; // è½‰æ›ç‚ºåˆ†é˜
        const deadline = 10 * 60 + 30; // 10:30 = 630 åˆ†é˜

        votingAllowed = currentTime < deadline;

        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        const timeDisplay = document.getElementById('timeDisplay');
        const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        if (votingAllowed) {
          const remainingMinutes = deadline - currentTime;
          const remainingHours = Math.floor(remainingMinutes / 60);
          const remainingMins = remainingMinutes % 60;
          timeDisplay.innerHTML = `ğŸ• ç•¶å‰æ™‚é–“ï¼š${timeStr}<br>è·é›¢æŠ•ç¥¨æˆªæ­¢é‚„æœ‰ ${remainingHours} å°æ™‚ ${remainingMins} åˆ†é˜`;
          timeDisplay.style.background = '#e3f2fd';
          timeDisplay.style.color = '#1976d2';
        } else {
          timeDisplay.innerHTML = `ğŸ• ç•¶å‰æ™‚é–“ï¼š${timeStr}<br>æŠ•ç¥¨å·²æˆªæ­¢ï¼ˆæˆªæ­¢æ™‚é–“ï¼š10:30ï¼‰`;
          timeDisplay.style.background = '#ffebee';
          timeDisplay.style.color = '#d32f2f';
        }

        // é¡¯ç¤ºæˆ–éš±è—æŠ•ç¥¨æˆªæ­¢è¨Šæ¯
        const votingClosedDiv = document.getElementById('votingClosed');
        const voteContainer = document.getElementById('voteContainer');
        
        if (!votingAllowed) {
          votingClosedDiv.classList.remove('hidden');
          voteContainer.style.opacity = '0.5';
          voteContainer.style.pointerEvents = 'none';
        } else {
          votingClosedDiv.classList.add('hidden');
          if (currentUser) {
            voteContainer.style.opacity = '1';
            voteContainer.style.pointerEvents = 'auto';
          }
        }

        return votingAllowed;
      }

      // æ¯ç§’æ›´æ–°æ™‚é–“æª¢æŸ¥
      setInterval(checkVotingTime, 1000);
      checkVotingTime();

      // è‡ªå‹•çµç®—æŠ•ç¥¨ä¸¦å¯«å…¥æ¯é€±èœå–®
      async function finalizeVoting() {
        try {
          const votesSnapshot = await get(votesRef);
          const votes = votesSnapshot.val();

          if (!votes) {
            console.log('ä»Šå¤©æ²’æœ‰ä»»ä½•æŠ•ç¥¨');
            return;
          }

          // æ‰¾å‡ºå¾—ç¥¨æœ€é«˜çš„åº—å®¶
          let maxVotes = 0;
          let winningRestaurant = null;

          for (const [restaurantId, voteCount] of Object.entries(votes)) {
            if (voteCount > maxVotes) {
              maxVotes = voteCount;
              winningRestaurant = restaurantId;
            }
          }

          if (winningRestaurant) {
            // å–å¾—åº—å®¶è³‡æ–™
            const restaurantSnapshot = await get(ref(database, `restaurants/${winningRestaurant}`));
            const restaurantData = restaurantSnapshot.val();

            // åˆ¤æ–·ä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾
            const dayOfWeek = new Date().getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, ..., 6=é€±å…­
            const dayMap = {
              1: 'monday',
              2: 'tuesday',
              3: 'wednesday',
              4: 'thursday',
              5: 'friday'
            };

            const dayKey = dayMap[dayOfWeek];

            if (dayKey) {
              // å¯«å…¥æ¯é€±èœå–®
              await set(ref(database, `weekly/${dayKey}`), {
                restaurantId: winningRestaurant,
                restaurantName: restaurantData?.name || winningRestaurant,
                votes: maxVotes,
                date: today
              });

              console.log(`ä»Šæ—¥ç²å‹åº—å®¶ï¼š${restaurantData?.name}ï¼Œå¾—ç¥¨æ•¸ï¼š${maxVotes}`);
            }
          }
        } catch (error) {
          console.error('çµç®—æŠ•ç¥¨å¤±æ•—ï¼š', error);
        }
      }

      // åœ¨ 10:30 æ™‚è‡ªå‹•åŸ·è¡Œçµç®—
      function scheduleFinalization() {
        const now = new Date();
        const target = new Date();
        target.setHours(10, 30, 0, 0);

        // å¦‚æœç¾åœ¨å·²ç¶“è¶…é 10:30ï¼Œè¨­å®šç‚ºæ˜å¤©çš„ 10:30
        if (now > target) {
          target.setDate(target.getDate() + 1);
        }

        const timeUntilFinalization = target - now;
        
        setTimeout(() => {
          finalizeVoting();
          // æ¯å¤©é‡è¤‡åŸ·è¡Œ
          setInterval(finalizeVoting, 24 * 60 * 60 * 1000);
        }, timeUntilFinalization);
      }

      scheduleFinalization();

      // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          showUserInfo(user);
          
          const emailKey = user.email.replace(/[.@]/g, '_');
          const voterSnapshot = await get(ref(database, `voters/${today}/${emailKey}`));
          
          if (voterSnapshot.exists()) {
            userCurrentVote = voterSnapshot.val();
            updateVoteUI(userCurrentVote);
          }
          
          if (votingAllowed) {
            document.getElementById('voteContainer').style.opacity = '1';
            document.getElementById('voteContainer').style.pointerEvents = 'auto';
          }
        } else {
          currentUser = null;
          userCurrentVote = null;
          document.getElementById('loginContainer').classList.remove('hidden');
          document.getElementById('userInfo').classList.add('hidden');
          document.getElementById('voteContainer').style.opacity = '0.5';
          document.getElementById('voteContainer').style.pointerEvents = 'none';
        }
      });

      // ç›£è½åº—å®¶è³‡æ–™è®ŠåŒ–
      onValue(restaurantsRef, (snapshot) => {
        const loadingDiv = document.getElementById('loadingRestaurants');
        const noRestaurantsDiv = document.getElementById('noRestaurants');
        const voteContainer = document.getElementById('voteContainer');

        loadingDiv.classList.add('hidden');

        const restaurants = snapshot.val();

        if (!restaurants) {
          noRestaurantsDiv.classList.remove('hidden');
          voteContainer.innerHTML = '';
          availableRestaurants = [];
          return;
        }

        availableRestaurants = Object.entries(restaurants)
          .filter(([id, data]) => data.isActive)
          .map(([id, data]) => ({
            id,
            ...data
          }));

        if (availableRestaurants.length === 0) {
          noRestaurantsDiv.classList.remove('hidden');
          voteContainer.innerHTML = '';
          return;
        }

        noRestaurantsDiv.classList.add('hidden');

        voteContainer.innerHTML = '';
        availableRestaurants.forEach(restaurant => {
          const voteOption = createVoteOption(restaurant);
          voteContainer.appendChild(voteOption);
        });

        if (userCurrentVote) {
          updateVoteUI(userCurrentVote);
        }
      });

      // å»ºç«‹æŠ•ç¥¨é¸é …
      function createVoteOption(restaurant) {
        const div = document.createElement('div');
        div.className = 'vote-option';
        div.setAttribute('data-restaurant', restaurant.id);

        const img = document.createElement('img');
        img.src = restaurant.imageUrl || 'https://via.placeholder.com/400x300?text=ç„¡åœ–ç‰‡';
        img.alt = restaurant.name;
        img.onerror = function() {
          this.src = 'https://via.placeholder.com/400x300?text=ç„¡åœ–ç‰‡';
        };

        const content = document.createElement('div');
        content.className = 'vote-option-content';

        const h3 = document.createElement('h3');
        h3.textContent = restaurant.name;

        const typeSpan = document.createElement('span');
        typeSpan.className = 'restaurant-type';
        typeSpan.textContent = restaurant.type || 'å…¶ä»–';

        const voteCount = document.createElement('p');
        voteCount.className = 'vote-count';
        voteCount.innerHTML = 'å¾—ç¥¨æ•¸ï¼š<span>0</span> ç¥¨';

        const button = document.createElement('button');
        button.className = 'vote-button not-selected';
        button.textContent = 'æŠ•ç¥¨';
        button.addEventListener('click', () => handleVote(restaurant.id));

        content.appendChild(h3);
        content.appendChild(typeSpan);
        content.appendChild(voteCount);
        content.appendChild(button);

        div.appendChild(img);
        div.appendChild(content);

        return div;
      }

      // å³æ™‚ç›£è½æŠ•ç¥¨æ•¸è®ŠåŒ–
      onValue(votesRef, (snapshot) => {
        const votes = snapshot.val() || {};
        
        document.querySelectorAll('.vote-option').forEach(option => {
          const restaurantId = option.getAttribute('data-restaurant');
          const countSpan = option.querySelector('.vote-count span');
          countSpan.textContent = votes[restaurantId] || 0;
        });
      });

      // æ›´æ–°æŠ•ç¥¨ UI
      function updateVoteUI(votedRestaurantId) {
        document.querySelectorAll('.vote-option').forEach(option => {
          const restaurantId = option.getAttribute('data-restaurant');
          const button = option.querySelector('.vote-button');
          
          if (restaurantId === votedRestaurantId) {
            option.classList.add('selected');
            button.classList.remove('not-selected');
            button.classList.add('selected');
            button.textContent = 'âœ“ ç›®å‰é¸æ“‡';
          } else {
            option.classList.remove('selected');
            button.classList.remove('selected');
            button.classList.add('not-selected');
            button.textContent = 'æ”¹æŠ•æ­¤åº—';
          }
        });
      }

      // è™•ç†æŠ•ç¥¨
      async function handleVote(restaurantId) {
        if (!currentUser) {
          alert('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
          return;
        }

        if (!votingAllowed) {
          alert('æŠ•ç¥¨æ™‚é–“å·²çµæŸï¼è«‹æ˜å¤©æ—©ä¸Š 10:30 å‰å†ä¾†æŠ•ç¥¨ã€‚');
          return;
        }

        if (restaurantId === userCurrentVote) {
          return;
        }

        const emailKey = currentUser.email.replace(/[.@]/g, '_');
        const voterRef = ref(database, `voters/${today}/${emailKey}`);

        try {
          if (userCurrentVote) {
            const oldRestaurantRef = ref(database, `votes/${today}/${userCurrentVote}`);
            await runTransaction(oldRestaurantRef, (currentVotes) => {
              return Math.max((currentVotes || 0) - 1, 0);
            });
          }

          const newRestaurantRef = ref(database, `votes/${today}/${restaurantId}`);
          await runTransaction(newRestaurantRef, (currentVotes) => {
            return (currentVotes || 0) + 1;
          });

          await set(voterRef, restaurantId);

          const oldVote = userCurrentVote;
          userCurrentVote = restaurantId;
          updateVoteUI(restaurantId);

          const restaurant = availableRestaurants.find(r => r.id === restaurantId);
          const restaurantName = restaurant ? restaurant.name : restaurantId;

          if (oldVote) {
            const oldRestaurant = availableRestaurants.find(r => r.id === oldVote);
            const oldName = oldRestaurant ? oldRestaurant.name : oldVote;
            console.log(`æŠ•ç¥¨å·²æ›´æ”¹ï¼š${oldName} â†’ ${restaurantName}`);
          } else {
            console.log(`æŠ•ç¥¨æˆåŠŸï¼š${restaurantName}`);
          }

        } catch (error) {
          console.error('æŠ•ç¥¨å¤±æ•—ï¼š', error);
          alert('æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }

      // Google ç™»å…¥æŒ‰éˆ•
      document.getElementById('google-signin-button').addEventListener('click', async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          
          if (!user.email.endsWith('@gmail.com')) {
            alert('è«‹ä½¿ç”¨ Gmail å¸³è™Ÿç™»å…¥ï¼');
            await signOut(auth);
            return;
          }
        } catch (error) {
          console.error('ç™»å…¥å¤±æ•—:', error);
          alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        }
      });

      // ç™»å‡ºæŒ‰éˆ•
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          location.reload();
        } catch (error) {
          console.error('ç™»å‡ºå¤±æ•—:', error);
        }
      });

      // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
      function showUserInfo(user) {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('userName').textContent = user.displayName || 'ä½¿ç”¨è€…';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/50';
      }
    </script>

  </body>

</html>