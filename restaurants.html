<!DOCTYPE html>
<html lang = "zh-TW">
  <head>
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ± - ä¾¿ç•¶åº—å®¶</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <!-- Header -->
    <div class = "header">
      <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
      <p>ä½ çš„åˆé¤æ•‘æ˜Ÿ ğŸŒŸ</p>
    </div>

    <!-- Navigation Bar -->
    <div class = "navbar">
      <a href="index.html">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</a>
      <a href="weekly.html">ğŸ“… æœ¬é€±åƒä»€éº¼</a>
      <a href="restaurants.html" class="active">ğŸª ä¾¿ç•¶åº—å®¶</a>
      <a href="add_restaurants.html"> â• æ–°å¢åº—å®¶</a>
    </div>

    <!-- Main Content -->
    <div class = "main">
      <!-- è¼‰å…¥ä¸­æç¤º -->
      <div id="loadingMessage" class="loading">
        <p>è¼‰å…¥åº—å®¶è³‡æ–™ä¸­...</p>
      </div>

      <!-- æ²’æœ‰åº—å®¶æ™‚çš„æç¤º -->
      <div id="noRestaurants" class="no-restaurants" style="display: none;">
        <h3>ğŸ“­ ç›®å‰é‚„æ²’æœ‰ä»»ä½•åº—å®¶</h3>
        <p>æˆç‚ºç¬¬ä¸€å€‹æ–°å¢åº—å®¶çš„äººå§ï¼</p>
        <a href="add_restaurants.html" class="add-restaurant-btn">â• ç«‹å³æ–°å¢åº—å®¶</a>
      </div>

      <!-- åº—å®¶åˆ—è¡¨ -->
      <section class="restaurant-list" id="restaurantList">
        <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥åº—å®¶å¡ç‰‡ -->
      </section>
    </div>

    <!-- ç·¨è¼¯è¡¨å–®å½ˆçª— -->
    <div id="editModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>âœï¸ ç·¨è¼¯åº—å®¶è³‡è¨Š</h2>
        
        <form id="editForm">
          <input type="hidden" id="editRestaurantId">
          
          <div class="form-group">
            <label for="editName">åº—å®¶åç¨± *</label>
            <input type="text" id="editName" required>
          </div>

          <div class="form-group">
            <label for="editType">åº—å®¶é¡å‹ *</label>
            <select id="editType" required>
              <option value="ä¾¿ç•¶">ä¾¿ç•¶</option>
              <option value="éºµé£Ÿ">éºµé£Ÿ</option>
              <option value="é£¯é¡">é£¯é¡</option>
              <option value="å°åƒ">å°åƒ</option>
              <option value="é€Ÿé£Ÿ">é€Ÿé£Ÿ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editAddress">åœ°å€</label>
            <input type="text" id="editAddress">
          </div>

          <div class="form-group">
            <label for="editPhone">é›»è©±</label>
            <input type="tel" id="editPhone">
          </div>

          <div class="form-group">
            <label for="editImageUrl">åœ–ç‰‡ç¶²å€</label>
            <input type="url" id="editImageUrl">
          </div>

          <div class="form-group">
            <label>å…¬ä¼‘æ—¥</label>
            <div class="checkbox-group">
              <label><input type="checkbox" class="editClosedDay" value="é€±ä¸€"> é€±ä¸€</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±äºŒ"> é€±äºŒ</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±ä¸‰"> é€±ä¸‰</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±å››"> é€±å››</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±äº”"> é€±äº”</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±å…­"> é€±å…­</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±æ—¥"> é€±æ—¥</label>
            </div>
          </div>

          <div class="form-group">
            <label for="editNote">å‚™è¨»</label>
            <textarea id="editNote" rows="3"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="button button-cancel" id="cancelEdit">å–æ¶ˆ</button>
            <button type="submit" class="button">å„²å­˜è®Šæ›´</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class = "footer">
      <p>ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 åˆé¤é»é¤ç³»çµ±</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        export const firebaseConfig = {
            apiKey: "AIzaSyAdo-mbq_BQ5tqY4nvscVNtah24Mb8ohmU",
            authDomain: "realtimevote-f8b6d.firebaseapp.com",
            databaseURL: "https://realtimevote-f8b6d-default-rtdb.firebaseio.com/",
            projectId: "realtimevote-f8b6d",
            storageBucket: "realtimevote-f8b6d.firebasestorage.app",
            messagingSenderId: "44615577610",
            appId: "1:44615577610:web:1bf827f2899ae2550d6ff3",
            measurementId: "G-MW1RJZSC0E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const restaurantsRef = ref(database, 'restaurants');

        let currentUser = null;

        // å‰µå»ºé è¨­åœ–ç‰‡ SVG (æ·ºç°è‰²èƒŒæ™¯ + ç…§ç‰‡åœ–æ¨™)
        const defaultImageSVG = `data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
            <rect width="400" height="300" fill="#f5f5f5"/>
            <g transform="translate(200, 150)">
              <rect x="-50" y="-40" width="100" height="80" rx="8" fill="none" stroke="#bdbdbd" stroke-width="3"/>
              <circle cx="-20" cy="-15" r="8" fill="#bdbdbd"/>
              <path d="M-40 20 L-20 -5 L10 15 L40 -10 L40 20 Z" fill="#e0e0e0"/>
            </g>
          </svg>
        `)}`;

        // æª¢æŸ¥åº—å®¶æ˜¯å¦ç‚ºæ–°åº—å®¶ï¼ˆ24å°æ™‚å…§æ–°å¢ï¼‰
        function isNewRestaurant(createdAt) {
          if (!createdAt) return false;
          const createdDate = new Date(createdAt);
          const now = new Date();
          const hoursDiff = (now - createdDate) / (1000 * 60 * 60);
          return hoursDiff < 24;
        }

        // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          updateAuthUI(user);
        });

        // æ›´æ–°ç™»å…¥ä»‹é¢
        function updateAuthUI(user) {
          const authInfo = document.getElementById('authInfo');
          const authButtons = document.getElementById('authButtons');

          if (user) {
            authInfo.innerHTML = `
              <img src="${user.photoURL || defaultImageSVG}" class="auth-avatar" alt="Avatar">
              <span class="auth-name">${user.displayName || user.email}</span>
            `;
            authButtons.innerHTML = `
              <button id="logoutBtn" class="logout-btn-small">ç™»å‡º</button>
            `;
            
            document.getElementById('logoutBtn').addEventListener('click', async () => {
              try {
                await signOut(auth);
                alert('å·²ç™»å‡º');
              } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
              }
            });
          } else {
            authInfo.innerHTML = `<span id="authStatus">æœªç™»å…¥ï¼ˆéœ€è¦ç™»å…¥æ‰èƒ½ç·¨è¼¯æˆ–åˆªé™¤åº—å®¶ï¼‰</span>`;
            authButtons.innerHTML = `
              <button id="loginBtn" class="login-btn-small">Google ç™»å…¥</button>
            `;
            
            document.getElementById('loginBtn').addEventListener('click', async () => {
              try {
                await signInWithPopup(auth, provider);
              } catch (error) {
                console.error('ç™»å…¥å¤±æ•—:', error);
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
              }
            });
          }
        }

        // ç›£è½åº—å®¶è³‡æ–™è®ŠåŒ–
        onValue(restaurantsRef, (snapshot) => {
          const loadingMessage = document.getElementById('loadingMessage');
          const noRestaurants = document.getElementById('noRestaurants');
          const restaurantList = document.getElementById('restaurantList');

          loadingMessage.style.display = 'none';
          restaurantList.innerHTML = '';

          const restaurants = snapshot.val();

          if (!restaurants) {
            noRestaurants.style.display = 'block';
            return;
          }

          noRestaurants.style.display = 'none';

          const restaurantArray = Object.entries(restaurants).map(([id, data]) => ({
            id,
            ...data
          })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          restaurantArray.forEach(restaurant => {
            if (restaurant.isActive) {
              const card = createRestaurantCard(restaurant);
              restaurantList.appendChild(card);
            }
          });
        });

        // å»ºç«‹åº—å®¶å¡ç‰‡
        function createRestaurantCard(restaurant) {
          const article = document.createElement('article');
          article.className = 'restaurant-card';

          if (isNewRestaurant(restaurant.createdAt)) {
            const newBadge = document.createElement('span');
            newBadge.className = 'new-badge';
            newBadge.textContent = 'âœ¨ NEW';
            article.appendChild(newBadge);
          }

          // åº—å®¶åœ–ç‰‡æˆ–ä½”ä½ç¬¦
          if (restaurant.imageUrl && restaurant.imageUrl.trim() !== '') {
            const img = document.createElement('img');
            img.src = restaurant.imageUrl;
            img.alt = restaurant.name;
            
            // åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨é è¨­åœ–ç‰‡
            img.onerror = function() {
              // æ›¿æ›ç‚ºä½”ä½ç¬¦
              const placeholder = createPlaceholder();
              this.parentNode.replaceChild(placeholder, this);
            };
            
            article.appendChild(img);
          } else {
            // ç›´æ¥ä½¿ç”¨ä½”ä½ç¬¦
            const placeholder = createPlaceholder();
            article.appendChild(placeholder);
          }

          // å¡ç‰‡å…§å®¹
          const cardBody = document.createElement('div');
          cardBody.className = 'card-body';

          const h3 = document.createElement('h3');
          h3.textContent = restaurant.name;

          const typeSpan = document.createElement('span');
          typeSpan.className = 'restaurant-type';
          typeSpan.textContent = restaurant.type || 'å…¶ä»–';

          const infoDiv = document.createElement('div');
          infoDiv.className = 'restaurant-info';

          if (restaurant.address) {
            const addressP = document.createElement('p');
            addressP.innerHTML = `åœ°å€: ${restaurant.address}`;
            infoDiv.appendChild(addressP);
          }

          if (restaurant.phone) {
            const phoneP = document.createElement('p');
            phoneP.innerHTML = `é›»è©±: ${restaurant.phone}`;
            infoDiv.appendChild(phoneP);
          }

          if (restaurant.closedDays && restaurant.closedDays.length > 0) {
            const closedP = document.createElement('p');
            closedP.className = 'closed-days';
            closedP.innerHTML = `å…¬ä¼‘æ—¥ï¼š${restaurant.closedDays.join('ã€')}`;
            infoDiv.appendChild(closedP);
          }

          if (restaurant.note) {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'restaurant-note';
            noteDiv.innerHTML = `ğŸ“ ${restaurant.note}`;
            infoDiv.appendChild(noteDiv);
          }

          const ratingDiv = document.createElement('div');
          ratingDiv.className = 'rating';
          
          const createdInfo = document.createElement('span');
          createdInfo.style.fontSize = '12px';
          createdInfo.style.color = '#999';
          createdInfo.textContent = `ç”± ${restaurant.createdByName || 'ä½¿ç”¨è€…'} æ–°å¢`;
          
          const buttonGroup = document.createElement('div');
          buttonGroup.className = 'button-group';

          const detailButton = document.createElement('a');
          detailButton.href = '#';
          detailButton.className = 'button';
          detailButton.textContent = 'æŸ¥çœ‹è©³æƒ…';
          detailButton.onclick = (e) => {
            e.preventDefault();
            showRestaurantDetail(restaurant);
          };

          const editButton = document.createElement('a');
          editButton.href = '#';
          editButton.className = 'button button-edit';
          editButton.textContent = 'ç·¨è¼¯';
          editButton.onclick = (e) => {
            e.preventDefault();
            editRestaurant(restaurant);
          };

          const deleteButton = document.createElement('a');
          deleteButton.href = '#';
          deleteButton.className = 'button button-delete';
          deleteButton.textContent = 'åˆªé™¤';
          deleteButton.onclick = (e) => {
            e.preventDefault();
            deleteRestaurant(restaurant);
          };

          buttonGroup.appendChild(detailButton);
          buttonGroup.appendChild(editButton);
          buttonGroup.appendChild(deleteButton);

          ratingDiv.appendChild(createdInfo);
          ratingDiv.appendChild(buttonGroup);

          cardBody.appendChild(h3);
          cardBody.appendChild(typeSpan);
          cardBody.appendChild(infoDiv);
          cardBody.appendChild(ratingDiv);

          article.appendChild(cardBody);

          return article;
        }

        // å‰µå»ºåœ–ç‰‡ä½”ä½ç¬¦
        function createPlaceholder() {
          const placeholder = document.createElement('div');
          placeholder.className = 'placeholder-image';
          
          placeholder.innerHTML = `
            <svg class="placeholder-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="8" y="12" width="48" height="40" rx="4" stroke="#bdbdbd" stroke-width="2"/>
              <circle cx="24" cy="26" r="4" fill="#bdbdbd"/>
              <path d="M12 44 L20 32 L32 40 L44 28 L52 36 V48 H12 V44 Z" fill="#e0e0e0"/>
            </svg>
          `;
          
          return placeholder;
        }

        // é¡¯ç¤ºåº—å®¶è©³ç´°è³‡è¨Š
        function showRestaurantDetail(restaurant) {
          let message = `ğŸ± ${restaurant.name}\n\n`;
          message += `é¡å‹ï¼š${restaurant.type}\n`;
          
          if (restaurant.address) {
            message += `åœ°å€ï¼š${restaurant.address}\n`;
          }
          
          if (restaurant.phone) {
            message += `é›»è©±ï¼š${restaurant.phone}\n`;
          }
          
          if (restaurant.closedDays && restaurant.closedDays.length > 0) {
            message += `å…¬ä¼‘æ—¥ï¼š${restaurant.closedDays.join('ã€')}\n`;
          }
          
          if (restaurant.note) {
            message += `\nå‚™è¨»ï¼š\n${restaurant.note}`;
          }

          if (restaurant.createdAt) {
            const createdDate = new Date(restaurant.createdAt);
            message += `\n\næ–°å¢æ™‚é–“ï¼š${createdDate.toLocaleString('zh-TW')}`;
          }

          alert(message);
        }

        // ç·¨è¼¯åº—å®¶
        function editRestaurant(restaurant) {
          if (!currentUser) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç·¨è¼¯åº—å®¶ï¼');
            return;
          }

          const modal = document.getElementById('editModal');
          modal.style.display = 'flex';

          document.getElementById('editRestaurantId').value = restaurant.id;
          document.getElementById('editName').value = restaurant.name || '';
          document.getElementById('editType').value = restaurant.type || 'ä¾¿ç•¶';
          document.getElementById('editAddress').value = restaurant.address || '';
          document.getElementById('editPhone').value = restaurant.phone || '';
          document.getElementById('editImageUrl').value = restaurant.imageUrl || '';
          document.getElementById('editNote').value = restaurant.note || '';

          document.querySelectorAll('.editClosedDay').forEach(checkbox => {
            checkbox.checked = restaurant.closedDays && restaurant.closedDays.includes(checkbox.value);
          });
        }

        // é—œé–‰ç·¨è¼¯å½ˆçª—
        document.querySelector('.close').addEventListener('click', () => {
          document.getElementById('editModal').style.display = 'none';
        });

        document.getElementById('cancelEdit').addEventListener('click', () => {
          document.getElementById('editModal').style.display = 'none';
        });

        window.addEventListener('click', (e) => {
          const modal = document.getElementById('editModal');
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });

        // è™•ç†ç·¨è¼¯è¡¨å–®æäº¤
        document.getElementById('editForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!currentUser) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç·¨è¼¯åº—å®¶ï¼');
            return;
          }

          const restaurantId = document.getElementById('editRestaurantId').value;
          
          const closedDays = Array.from(document.querySelectorAll('.editClosedDay:checked'))
            .map(cb => cb.value);

          const updatedData = {
            name: document.getElementById('editName').value,
            type: document.getElementById('editType').value,
            address: document.getElementById('editAddress').value,
            phone: document.getElementById('editPhone').value,
            imageUrl: document.getElementById('editImageUrl').value,
            closedDays: closedDays,
            note: document.getElementById('editNote').value,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser.uid,
            updatedByName: currentUser.displayName || currentUser.email
          };

          try {
            const restaurantRef = ref(database, `restaurants/${restaurantId}`);
            await update(restaurantRef, updatedData);
            
            alert('åº—å®¶è³‡è¨Šå·²æ›´æ–°æˆåŠŸï¼');
            document.getElementById('editModal').style.display = 'none';
          } catch (error) {
            console.error('æ›´æ–°å¤±æ•—ï¼š', error);
            alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
          }
        });

        // åˆªé™¤åº—å®¶
        function deleteRestaurant(restaurant) {
          if (!currentUser) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½åˆªé™¤åº—å®¶ï¼');
            return;
          }

          const confirmDelete = confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${restaurant.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`);
          
          if (confirmDelete) {
            const restaurantRef = ref(database, `restaurants/${restaurant.id}`);
            
            remove(restaurantRef)
              .then(() => {
                alert('åº—å®¶å·²æˆåŠŸåˆªé™¤ï¼');
              })
              .catch((error) => {
                console.error('åˆªé™¤å¤±æ•—ï¼š', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message + '\n\nè«‹ç¢ºèªæ‚¨å·²ç™»å…¥ä¸”æœ‰æ¬Šé™åˆªé™¤æ­¤åº—å®¶ã€‚');
              });
          }
        }

        // å‹•æ…‹èª¿æ•´ä½ç½®
        function adjustPositions() {
          const header = document.querySelector('.header');
          const navbar = document.querySelector('.navbar');
          const main = document.querySelector('.main');
          
          if (header && navbar) {
            const headerRect = header.getBoundingClientRect();
            navbar.style.top = headerRect.bottom + 'px';
          }
          
          if (navbar && main) {
            const navbarRect = navbar.getBoundingClientRect();
            main.style.top = navbarRect.bottom + 'px';
          }
        }

        window.addEventListener('load', adjustPositions);
        window.addEventListener('resize', adjustPositions);

        const header = document.querySelector('.header');
        const navbar = document.querySelector('.navbar');

        if (header) {
          const headerObserver = new ResizeObserver(adjustPositions);
          headerObserver.observe(header);
        }

        if (navbar) {
          const navbarObserver = new ResizeObserver(adjustPositions);
          navbarObserver.observe(navbar);
        }
    </script>

  </body>
</html>