<!DOCTYPE html>
<html lang = "zh-TW">
  <head>
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ± - ä¾¿ç•¶åº—å®¶</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <!-- Header -->
    <div class = "header">
      <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
      <p>ä½ çš„åˆé¤æ•‘æ˜Ÿ ğŸŒŸ</p>
    </div>

    <!-- Navigation Bar -->
    <div class = "navbar">
      <a href="index.html">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</a>
      <a href="weekly.html">ğŸ“… æœ¬é€±åƒä»€éº¼</a>
      <a href="restaurants.html" class="active">ğŸª ä¾¿ç•¶åº—å®¶</a>
      <a href="add_restaurants.html"> â• æ–°å¢åº—å®¶</a>
    </div>

    <!-- ç™»å…¥ç‹€æ…‹åˆ— -->
    <div class="auth-bar">
        <div id="authInfo" class="auth-info">
            <span id="authStatus">æœªç™»å…¥</span>
        </div>
        <div id="authButtons">
            <button id="loginBtn" class="login-btn-small">Google ç™»å…¥</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class = "main">
      <!-- è¼‰å…¥ä¸­æç¤º -->
      <div id="loadingMessage" class="loading">
        <p>è¼‰å…¥åº—å®¶è³‡æ–™ä¸­...</p>
      </div>

      <!-- æ²’æœ‰åº—å®¶æ™‚çš„æç¤º -->
      <div id="noRestaurants" class="no-restaurants" style="display: none;">
        <h3>ğŸ“­ ç›®å‰é‚„æ²’æœ‰ä»»ä½•åº—å®¶</h3>
        <p>æˆç‚ºç¬¬ä¸€å€‹æ–°å¢åº—å®¶çš„äººå§ï¼</p>
        <a href="add_restaurants.html" class="add-restaurant-btn">â• ç«‹å³æ–°å¢åº—å®¶</a>
      </div>

      <!-- åº—å®¶åˆ—è¡¨ -->
      <section class="restaurant-list" id="restaurantList">
        <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥åº—å®¶å¡ç‰‡ -->
      </section>
    </div>

    <!-- ç·¨è¼¯è¡¨å–®å½ˆçª— -->
    <div id="editModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>âœï¸ ç·¨è¼¯åº—å®¶è³‡è¨Š</h2>
        
        <form id="editForm">
          <input type="hidden" id="editRestaurantId">
          
          <div class="form-group">
            <label for="editName">åº—å®¶åç¨± *</label>
            <input type="text" id="editName" required>
          </div>

          <div class="form-group">
            <label for="editType">åº—å®¶é¡å‹ *</label>
            <select id="editType" required>
              <option value="ä¾¿ç•¶">ä¾¿ç•¶</option>
              <option value="éºµé£Ÿ">éºµé£Ÿ</option>
              <option value="é£¯é¡">é£¯é¡</option>
              <option value="å°åƒ">å°åƒ</option>
              <option value="é€Ÿé£Ÿ">é€Ÿé£Ÿ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editAddress">åœ°å€</label>
            <input type="text" id="editAddress">
          </div>

          <div class="form-group">
            <label for="editPhone">é›»è©±</label>
            <input type="tel" id="editPhone">
          </div>

          <div class="form-group">
            <label for="editImageUrl">åœ–ç‰‡ç¶²å€</label>
            <input type="url" id="editImageUrl">
          </div>

          <div class="form-group">
            <label>å…¬ä¼‘æ—¥</label>
            <div class="checkbox-group">
              <label><input type="checkbox" class="editClosedDay" value="é€±ä¸€"> é€±ä¸€</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±äºŒ"> é€±äºŒ</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±ä¸‰"> é€±ä¸‰</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±å››"> é€±å››</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±äº”"> é€±äº”</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±å…­"> é€±å…­</label>
              <label><input type="checkbox" class="editClosedDay" value="é€±æ—¥"> é€±æ—¥</label>
            </div>
          </div>

          <div class="form-group">
            <label for="editNote">å‚™è¨»</label>
            <textarea id="editNote" rows="3"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="button button-cancel" id="cancelEdit">å–æ¶ˆ</button>
            <button type="submit" class="button">å„²å­˜è®Šæ›´</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class = "footer">
      <p>ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 åˆé¤é»é¤ç³»çµ±</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        export const firebaseConfig = {
            apiKey: "AIzaSyAdo-mbq_BQ5tqY4nvscVNtah24Mb8ohmU",
            authDomain: "realtimevote-f8b6d.firebaseapp.com",
            databaseURL: "https://realtimevote-f8b6d-default-rtdb.firebaseio.com/",
            projectId: "realtimevote-f8b6d",
            storageBucket: "realtimevote-f8b6d.firebasestorage.app",
            messagingSenderId: "44615577610",
            appId: "1:44615577610:web:1bf827f2899ae2550d6ff3",
            measurementId: "G-MW1RJZSC0E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const restaurantsRef = ref(database, 'restaurants');

        let currentUser = null;

        // æª¢æŸ¥åº—å®¶æ˜¯å¦ç‚ºæ–°åº—å®¶ï¼ˆ24å°æ™‚å…§æ–°å¢ï¼‰
        function isNewRestaurant(createdAt) {
            if (!createdAt) return false;
            
            const createdDate = new Date(createdAt);
            const now = new Date();
            const hoursDiff = (now - createdDate) / (1000 * 60 * 60); // è½‰æ›ç‚ºå°æ™‚
            
            return hoursDiff < 24; // 24å°æ™‚å…§ç®—æ–°åº—å®¶
        }

        // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthUI(user);
        });

        // æ›´æ–°ç™»å…¥ä»‹é¢
        function updateAuthUI(user) {
            const authInfo = document.getElementById('authInfo');
            const authButtons = document.getElementById('authButtons');

            if (user) {
                authInfo.innerHTML = `
                    <img src="${user.photoURL || 'https://via.placeholder.com/32'}" class="auth-avatar" alt="Avatar">
                    <span class="auth-name">${user.displayName || user.email}</span>
                `;
                authButtons.innerHTML = `
                    <button id="logoutBtn" class="logout-btn-small">ç™»å‡º</button>
                `;
                
                // ç¶å®šç™»å‡ºæŒ‰éˆ•
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        alert('å·²ç™»å‡º');
                    } catch (error) {
                        console.error('ç™»å‡ºå¤±æ•—:', error);
                    }
                });
            } else {
                authInfo.innerHTML = `<span id="authStatus">æœªç™»å…¥ï¼ˆéœ€è¦ç™»å…¥æ‰èƒ½ç·¨è¼¯æˆ–åˆªé™¤åº—å®¶ï¼‰</span>`;
                authButtons.innerHTML = `
                    <button id="loginBtn" class="login-btn-small">Google ç™»å…¥</button>
                `;
                
                // ç¶å®šç™»å…¥æŒ‰éˆ•
                document.getElementById('loginBtn').addEventListener('click', async () => {
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error('ç™»å…¥å¤±æ•—:', error);
                        alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
                    }
                });
            }
        }

        // ç›£è½åº—å®¶è³‡æ–™è®ŠåŒ–
        onValue(restaurantsRef, (snapshot) => {
            const loadingMessage = document.getElementById('loadingMessage');
            const noRestaurants = document.getElementById('noRestaurants');
            const restaurantList = document.getElementById('restaurantList');

            // éš±è—è¼‰å…¥è¨Šæ¯
            loadingMessage.style.display = 'none';

            // æ¸…ç©ºç¾æœ‰å…§å®¹
            restaurantList.innerHTML = '';

            const restaurants = snapshot.val();

            // å¦‚æœæ²’æœ‰åº—å®¶è³‡æ–™
            if (!restaurants) {
                noRestaurants.style.display = 'block';
                return;
            }

            // éš±è—ã€Œæ²’æœ‰åº—å®¶ã€æç¤º
            noRestaurants.style.display = 'none';

            // å°‡åº—å®¶è³‡æ–™è½‰æ›æˆé™£åˆ—ä¸¦æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const restaurantArray = Object.entries(restaurants).map(([id, data]) => ({
                id,
                ...data
            })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // å‹•æ…‹ç”Ÿæˆåº—å®¶å¡ç‰‡
            restaurantArray.forEach(restaurant => {
                if (restaurant.isActive) {  // åªé¡¯ç¤ºå•Ÿç”¨çš„åº—å®¶
                    const card = createRestaurantCard(restaurant);
                    restaurantList.appendChild(card);
                }
            });
        });

        // å»ºç«‹åº—å®¶å¡ç‰‡
        function createRestaurantCard(restaurant) {
            const article = document.createElement('article');
            article.className = 'restaurant-card';

            // å¦‚æœæ˜¯æ–°åº—å®¶ï¼ŒåŠ ä¸Š NEW æ¨™ç±¤
            if (isNewRestaurant(restaurant.createdAt)) {
                const newBadge = document.createElement('span');
                newBadge.className = 'new-badge';
                newBadge.textContent = 'âœ¨ NEW';
                article.appendChild(newBadge);
            }

            // åº—å®¶åœ–ç‰‡
            const img = document.createElement('img');
            img.src = restaurant.imageUrl || 'https://via.placeholder.com/400x300?text=ç„¡åœ–ç‰‡';
            img.alt = restaurant.name;
            img.onerror = function() {
                this.src = 'https://via.placeholder.com/400x300?text=ç„¡åœ–ç‰‡';
            };

            // å¡ç‰‡å…§å®¹
            const cardBody = document.createElement('article');
            cardBody.className = 'card-body';

            // åº—å®¶åç¨±
            const h3 = document.createElement('h3');
            h3.textContent = restaurant.name;

            // åº—å®¶é¡å‹æ¨™ç±¤
            const typeSpan = document.createElement('span');
            typeSpan.className = 'restaurant-type';
            typeSpan.textContent = restaurant.type || 'å…¶ä»–';

            // åº—å®¶è³‡è¨Š
            const infoDiv = document.createElement('div');
            infoDiv.className = 'restaurant-info';

            // åœ°å€
            if (restaurant.address) {
                const addressP = document.createElement('p');
                addressP.innerHTML = `${restaurant.address}`;
                infoDiv.appendChild(addressP);
            }

            // é›»è©±
            if (restaurant.phone) {
                const phoneP = document.createElement('p');
                phoneP.innerHTML = `${restaurant.phone}`;
                infoDiv.appendChild(phoneP);
            }

            // å…¬ä¼‘æ—¥
            if (restaurant.closedDays && restaurant.closedDays.length > 0) {
                const closedP = document.createElement('p');
                closedP.className = 'closed-days';
                closedP.innerHTML = `å…¬ä¼‘æ—¥ï¼š${restaurant.closedDays.join('ã€')}`;
                infoDiv.appendChild(closedP);
            }

            // å‚™è¨»
            if (restaurant.note) {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'restaurant-note';
                noteDiv.innerHTML = `${restaurant.note}`;
                infoDiv.appendChild(noteDiv);
            }

            // è©•åˆ†å€åŸŸ
            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'rating';
            
            // æ–°å¢è€…è³‡è¨Š
            const createdInfo = document.createElement('span');
            createdInfo.style.fontSize = '12px';
            createdInfo.style.color = '#999';
            createdInfo.textContent = `ç”± ${restaurant.createdByName || 'ä½¿ç”¨è€…'} æ–°å¢`;
            
            // æŒ‰éˆ•å®¹å™¨
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';

            // æŸ¥çœ‹è©³æƒ…æŒ‰éˆ•
            const detailButton = document.createElement('a');
            detailButton.href = '#';
            detailButton.className = 'button';
            detailButton.textContent = 'æŸ¥çœ‹è©³æƒ…';
            detailButton.onclick = (e) => {
                e.preventDefault();
                showRestaurantDetail(restaurant);
            };

            // ç·¨è¼¯æŒ‰éˆ•
            const editButton = document.createElement('a');
            editButton.href = '#';
            editButton.className = 'button button-edit';
            editButton.textContent = 'ç·¨è¼¯';
            editButton.onclick = (e) => {
                e.preventDefault();
                editRestaurant(restaurant);
            };

            // åˆªé™¤æŒ‰éˆ•
            const deleteButton = document.createElement('a');
            deleteButton.href = '#';
            deleteButton.className = 'button button-delete';
            deleteButton.textContent = 'åˆªé™¤';
            deleteButton.onclick = (e) => {
                e.preventDefault();
                deleteRestaurant(restaurant);
            };

            buttonGroup.appendChild(detailButton);
            buttonGroup.appendChild(editButton);
            buttonGroup.appendChild(deleteButton);

            ratingDiv.appendChild(createdInfo);
            ratingDiv.appendChild(buttonGroup);

            // çµ„åˆæ‰€æœ‰å…ƒç´ 
            cardBody.appendChild(h3);
            cardBody.appendChild(typeSpan);
            cardBody.appendChild(infoDiv);
            cardBody.appendChild(ratingDiv);

            article.appendChild(img);
            article.appendChild(cardBody);

            return article;
        }

        // é¡¯ç¤ºåº—å®¶è©³ç´°è³‡è¨Š
        function showRestaurantDetail(restaurant) {
            let message = `${restaurant.name}\n\n`;
            message += `é¡å‹ï¼š${restaurant.type}\n`;
            
            if (restaurant.address) {
                message += `åœ°å€ï¼š${restaurant.address}\n`;
            }
            
            if (restaurant.phone) {
                message += `é›»è©±ï¼š${restaurant.phone}\n`;
            }
            
            if (restaurant.closedDays && restaurant.closedDays.length > 0) {
                message += `å…¬ä¼‘æ—¥ï¼š${restaurant.closedDays.join('ã€')}\n`;
            }
            
            if (restaurant.note) {
                message += `\nå‚™è¨»ï¼š\n${restaurant.note}`;
            }

            // é¡¯ç¤ºæ–°å¢æ™‚é–“
            if (restaurant.createdAt) {
                const createdDate = new Date(restaurant.createdAt);
                message += `\n\næ–°å¢æ™‚é–“ï¼š${createdDate.toLocaleString('zh-TW')}`;
            }

            alert(message);
        }

        // ç·¨è¼¯åº—å®¶
        function editRestaurant(restaurant) {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç·¨è¼¯åº—å®¶ï¼');
                return;
            }

            // é¡¯ç¤ºç·¨è¼¯å½ˆçª—
            const modal = document.getElementById('editModal');
            modal.style.display = 'flex';

            // å¡«å…¥ç¾æœ‰è³‡æ–™
            document.getElementById('editRestaurantId').value = restaurant.id;
            document.getElementById('editName').value = restaurant.name || '';
            document.getElementById('editType').value = restaurant.type || 'ä¾¿ç•¶';
            document.getElementById('editAddress').value = restaurant.address || '';
            document.getElementById('editPhone').value = restaurant.phone || '';
            document.getElementById('editImageUrl').value = restaurant.imageUrl || '';
            document.getElementById('editNote').value = restaurant.note || '';

            // è¨­å®šå…¬ä¼‘æ—¥
            document.querySelectorAll('.editClosedDay').forEach(checkbox => {
                checkbox.checked = restaurant.closedDays && restaurant.closedDays.includes(checkbox.value);
            });
        }

        // é—œé–‰ç·¨è¼¯å½ˆçª—
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
        });

        document.getElementById('cancelEdit').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
        });

        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('editModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // è™•ç†ç·¨è¼¯è¡¨å–®æäº¤
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ç·¨è¼¯åº—å®¶ï¼');
                return;
            }

            const restaurantId = document.getElementById('editRestaurantId').value;
            
            // æ”¶é›†å…¬ä¼‘æ—¥
            const closedDays = Array.from(document.querySelectorAll('.editClosedDay:checked'))
                .map(cb => cb.value);

            const updatedData = {
                name: document.getElementById('editName').value,
                type: document.getElementById('editType').value,
                address: document.getElementById('editAddress').value,
                phone: document.getElementById('editPhone').value,
                imageUrl: document.getElementById('editImageUrl').value,
                closedDays: closedDays,
                note: document.getElementById('editNote').value,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.uid,
                updatedByName: currentUser.displayName || currentUser.email
            };

            try {
                const restaurantRef = ref(database, `restaurants/${restaurantId}`);
                await update(restaurantRef, updatedData);
                
                alert('åº—å®¶è³‡è¨Šå·²æ›´æ–°æˆåŠŸï¼');
                document.getElementById('editModal').style.display = 'none';
            } catch (error) {
                console.error('æ›´æ–°å¤±æ•—ï¼š', error);
                alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
            }
        });

        // åˆªé™¤åº—å®¶
        function deleteRestaurant(restaurant) {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½åˆªé™¤åº—å®¶ï¼');
                return;
            }

            const confirmDelete = confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${restaurant.name}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`);
            
            if (confirmDelete) {
                const restaurantRef = ref(database, `restaurants/${restaurant.id}`);
                
                remove(restaurantRef)
                    .then(() => {
                        alert('åº—å®¶å·²æˆåŠŸåˆªé™¤ï¼');
                    })
                    .catch((error) => {
                        console.error('åˆªé™¤å¤±æ•—ï¼š', error);
                        alert('åˆªé™¤å¤±æ•—ï¼š' + error.message + '\n\nè«‹ç¢ºèªæ‚¨å·²ç™»å…¥ä¸”æœ‰æ¬Šé™åˆªé™¤æ­¤åº—å®¶ã€‚');
                    });
            }
        }
    </script>

  </body>
</html>