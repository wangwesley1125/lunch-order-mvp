<!DOCTYPE html>
<html lang = "zh-TW">
  <head>
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ± - æ–°å¢åº—å®¶</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <!-- Header -->
    <div class = "header">
      <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
      <p>ä½ çš„åˆé¤æ•‘æ˜Ÿ ğŸŒŸ</p>
    </div>

    <!-- Navigation Bar -->
    <div class = "navbar">
      <a href="index.html">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</a>
      <a href="weekly.html">ğŸ“… æœ¬é€±åƒä»€éº¼</a>
      <a href="restaurants.html">ğŸª ä¾¿ç•¶åº—å®¶</a>
      <a href="add_restaurants.html" class="active"> â• æ–°å¢åº—å®¶</a>
    </div>

    <!-- Main Content -->
    <div class = "main">
      <section class="add-restaurant-section">
            <h2>â• æ–°å¢åº—å®¶</h2>

            <!-- ç™»å…¥æç¤º -->
            <div id="loginNotice" class="login-notice">
                <h3>ğŸ” è«‹å…ˆç™»å…¥</h3>
                <p>æ‚¨éœ€è¦ç™»å…¥ Google å¸³è™Ÿæ‰èƒ½æ–°å¢åº—å®¶ ğŸ˜…</p>
                <button id="googleSigninBtn" class="login-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    ä½¿ç”¨ Google ç™»å…¥
                </button>
            </div>

            <!-- ä½¿ç”¨è€…è³‡è¨Š -->
            <div id="userInfoSection" class="user-info hidden">
                <div class="user-info-left">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div>
                        <div id="userName" style="font-weight: bold;"></div>
                        <div id="userEmail" style="font-size: 14px; color: #666;"></div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
            </div>

            <!-- æ–°å¢åº—å®¶è¡¨å–® -->
            <div id="formContainer" class="form-container hidden">
                <form id="addRestaurantForm">
                    <!-- åº—å®¶åç¨± -->
                    <div class="form-group">
                        <label for="restaurantName">åº—å®¶åç¨± <span class="required">*</span></label>
                        <input type="text" id="restaurantName" name="restaurantName" required placeholder="ä¾‹å¦‚ï¼šç‹å¤§å‰æ’éª¨é£¯">
                    </div>

                    <!-- åº—å®¶é¡å‹ -->
                    <div class="form-group">
                        <label for="restaurantType">åº—å®¶é¡å‹ <span class="required">*</span></label>
                        <select id="restaurantType" name="restaurantType" required>
                            <option value="">è«‹é¸æ“‡åº—å®¶é¡å‹</option>
                            <option value="ä¾¿ç•¶">ä¾¿ç•¶</option>
                            <option value="éºµé£Ÿ">éºµé£Ÿ</option>
                            <option value="æ°´é¤ƒé‹è²¼">æ°´é¤ƒé‹è²¼</option>
                            <option value="å°åƒ">å°åƒ</option>
                            <option value="é£¯é¡">é£¯é¡</option>
                            <option value="ç´ é£Ÿ">ç´ é£Ÿ</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>

                    <!-- åº—å®¶ç…§ç‰‡ URL -->
                    <div class="form-group">
                        <label for="restaurantImage">åº—å®¶ç…§ç‰‡ç¶²å€</label>
                        <input type="url" id="restaurantImage" name="restaurantImage" placeholder="https://example.com/image.jpg">
                        <p class="help-text">è«‹æä¾›åº—å®¶ç…§ç‰‡çš„ç¶²å€ï¼ˆé¸å¡«ï¼‰</p>
                    </div>

                    <!-- åº—å®¶åœ°å€ -->
                    <div class="form-group">
                        <label for="restaurantAddress">åº—å®¶åœ°å€</label>
                        <input type="text" id="restaurantAddress" name="restaurantAddress" placeholder="ä¾‹å¦‚ï¼šé«˜é›„å¸‚ä¸‰æ°‘å€ä¸­æ­£è·¯123è™Ÿ">
                    </div>

                    <!-- é›»è©± -->
                    <div class="form-group">
                        <label for="restaurantPhone">é›»è©±</label>
                        <input type="tel" id="restaurantPhone" name="restaurantPhone" placeholder="ä¾‹å¦‚ï¼š07-1234567">
                    </div>

                    <!-- å…¬ä¼‘æ—¥ -->
                    <div class="form-group">
                        <label>å…¬ä¼‘æ—¥</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="day1" name="closedDays" value="æ˜ŸæœŸä¸€">
                                <label for="day1">æ˜ŸæœŸä¸€</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day2" name="closedDays" value="æ˜ŸæœŸäºŒ">
                                <label for="day2">æ˜ŸæœŸäºŒ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day3" name="closedDays" value="æ˜ŸæœŸä¸‰">
                                <label for="day3">æ˜ŸæœŸä¸‰</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day4" name="closedDays" value="æ˜ŸæœŸå››">
                                <label for="day4">æ˜ŸæœŸå››</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day5" name="closedDays" value="æ˜ŸæœŸäº”">
                                <label for="day5">æ˜ŸæœŸäº”</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day6" name="closedDays" value="æ˜ŸæœŸå…­">
                                <label for="day6">æ˜ŸæœŸå…­</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day7" name="closedDays" value="æ˜ŸæœŸæ—¥">
                                <label for="day7">æ˜ŸæœŸæ—¥</label>
                            </div>
                        </div>
                        <p class="help-text">è«‹å‹¾é¸åº—å®¶çš„å…¬ä¼‘æ—¥ï¼ˆå¯è¤‡é¸ï¼‰</p>
                    </div>

                    <!-- å‚™è¨» -->
                    <div class="form-group">
                        <label for="restaurantNote">å‚™è¨»</label>
                        <textarea id="restaurantNote" name="restaurantNote" placeholder="ä¾‹å¦‚ï¼šæ¨è–¦æ‹›ç‰Œé›è…¿é£¯ã€ç‡Ÿæ¥­æ™‚é–“ 11:00-14:00"></textarea>
                        <p class="help-text">å¯ä»¥å¡«å¯«æ¨è–¦èœè‰²ã€ç‡Ÿæ¥­æ™‚é–“ç­‰è³‡è¨Š</p>
                    </div>

                    <!-- æäº¤æŒ‰éˆ• -->
                    <button type="submit" class="submit-btn" id="submitBtn">ç¢ºå®šæ–°å¢</button>
                </form>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <div class = "footer">
      <p>ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 åˆé¤é»é¤ç³»çµ±</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, push, set, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        export const firebaseConfig = {
            apiKey: "AIzaSyAdo-mbq_BQ5tqY4nvscVNtah24Mb8ohmU",
            authDomain: "realtimevote-f8b6d.firebaseapp.com",
            databaseURL: "https://realtimevote-f8b6d-default-rtdb.firebaseio.com/",
            projectId: "realtimevote-f8b6d",
            storageBucket: "realtimevote-f8b6d.firebasestorage.app",
            messagingSenderId: "44615577610",
            appId: "1:44615577610:web:1bf827f2899ae2550d6ff3",
            measurementId: "G-MW1RJZSC0E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isEditMode = false;
        let editRestaurantId = null;
        let editRestaurantData = null;

        // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('edit')) {
            isEditMode = true;
            editRestaurantId = urlParams.get('edit');
            
            // å¾ sessionStorage è®€å–åº—å®¶è³‡æ–™
            const storedData = sessionStorage.getItem('editRestaurant');
            if (storedData) {
                editRestaurantData = JSON.parse(storedData);
                // æ›´æ”¹é é¢æ¨™é¡Œ
                document.getElementById('pageTitle').innerHTML = 'âœï¸ ç·¨è¼¯åº—å®¶';
                document.getElementById('submitBtn').textContent = 'ç¢ºå®šæ›´æ–°';
            } else {
                alert('æ‰¾ä¸åˆ°åº—å®¶è³‡æ–™ï¼Œå°‡è¿”å›åº—å®¶åˆ—è¡¨');
                window.location.href = 'restaurants.html';
            }
        }

        // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showUserInfo(user);
                document.getElementById('loginNotice').classList.add('hidden');
                document.getElementById('userInfoSection').classList.remove('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
                
                // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œå¡«å…¥è³‡æ–™
                if (isEditMode && editRestaurantData) {
                    fillFormWithData(editRestaurantData);
                }
            } else {
                currentUser = null;
                document.getElementById('loginNotice').classList.remove('hidden');
                document.getElementById('userInfoSection').classList.add('hidden');
                document.getElementById('formContainer').classList.add('hidden');
            }
        });

        // å¡«å…¥è¡¨å–®è³‡æ–™ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
        function fillFormWithData(data) {
            document.getElementById('restaurantName').value = data.name || '';
            document.getElementById('restaurantType').value = data.type || '';
            document.getElementById('restaurantImage').value = data.imageUrl || '';
            document.getElementById('restaurantAddress').value = data.address || '';
            document.getElementById('restaurantPhone').value = data.phone || '';
            document.getElementById('restaurantNote').value = data.note || '';
            
            // å‹¾é¸å…¬ä¼‘æ—¥
            if (data.closedDays && Array.isArray(data.closedDays)) {
                data.closedDays.forEach(day => {
                    const checkbox = document.querySelector(`input[name="closedDays"][value="${day}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        }

        // Google ç™»å…¥
        document.getElementById('googleSigninBtn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                if (!user.email.endsWith('@gmail.com')) {
                    alert('è«‹ä½¿ç”¨ Gmail å¸³è™Ÿç™»å…¥ï¼');
                    await signOut(auth);
                    return;
                }
            } catch (error) {
                console.error('ç™»å…¥å¤±æ•—:', error);
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        });

        // ç™»å‡º
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
            }
        });

        // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
        function showUserInfo(user) {
            document.getElementById('userName').textContent = user.displayName || 'ä½¿ç”¨è€…';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/50';
        }

        // è¡¨å–®æäº¤
        document.getElementById('addRestaurantForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = isEditMode ? 'æ›´æ–°ä¸­...' : 'æ–°å¢ä¸­...';

            // æ”¶é›†å…¬ä¼‘æ—¥
            const closedDays = [];
            document.querySelectorAll('input[name="closedDays"]:checked').forEach(checkbox => {
                closedDays.push(checkbox.value);
            });

            // æ”¶é›†è¡¨å–®è³‡æ–™
            const restaurantData = {
                name: document.getElementById('restaurantName').value.trim(),
                type: document.getElementById('restaurantType').value,
                imageUrl: document.getElementById('restaurantImage').value.trim() || 'https://via.placeholder.com/400x300?text=ç„¡åœ–ç‰‡',
                address: document.getElementById('restaurantAddress').value.trim(),
                phone: document.getElementById('restaurantPhone').value.trim(),
                closedDays: closedDays,
                note: document.getElementById('restaurantNote').value.trim(),
                isActive: true
            };

            try {
                if (isEditMode) {
                    // ç·¨è¼¯æ¨¡å¼ - æ›´æ–°ç¾æœ‰åº—å®¶
                    restaurantData.updatedAt = new Date().toISOString();
                    restaurantData.updatedBy = currentUser.email;
                    restaurantData.updatedByName = currentUser.displayName || 'ä½¿ç”¨è€…';
                    
                    // ä¿ç•™åŸæœ¬çš„å»ºç«‹è³‡è¨Š
                    restaurantData.createdAt = editRestaurantData.createdAt;
                    restaurantData.createdBy = editRestaurantData.createdBy;
                    restaurantData.createdByName = editRestaurantData.createdByName;
                    
                    const restaurantRef = ref(database, `restaurants/${editRestaurantId}`);
                    await update(restaurantRef, restaurantData);
                    
                    alert('åº—å®¶æ›´æ–°æˆåŠŸï¼');
                    
                    // æ¸…é™¤ sessionStorage
                    sessionStorage.removeItem('editRestaurant');
                    
                } else {
                    // æ–°å¢æ¨¡å¼
                    restaurantData.createdAt = new Date().toISOString();
                    restaurantData.createdBy = currentUser.email;
                    restaurantData.createdByName = currentUser.displayName || 'ä½¿ç”¨è€…';
                    
                    const restaurantsRef = ref(database, 'restaurants');
                    const newRestaurantRef = push(restaurantsRef);
                    await set(newRestaurantRef, restaurantData);
                    
                    alert('åº—å®¶æ–°å¢æˆåŠŸï¼');
                }
                
                // å°å‘åˆ°åº—å®¶åˆ—è¡¨é é¢
                setTimeout(() => {
                    window.location.href = 'restaurants.html';
                }, 1000);

            } catch (error) {
                console.error(isEditMode ? 'æ›´æ–°å¤±æ•—:' : 'æ–°å¢å¤±æ•—:', error);
                alert((isEditMode ? 'æ›´æ–°å¤±æ•—' : 'æ–°å¢å¤±æ•—') + 'ï¼Œè«‹ç¨å¾Œå†è©¦ï¼š' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isEditMode ? 'ç¢ºå®šæ›´æ–°' : 'ç¢ºå®šæ–°å¢';
            }
        });

        // å‹•æ…‹èª¿æ•´ä½ç½®ï¼Œé¿å…æœ‰ç©ºéš™
      function adjustPositions() {
        const header = document.querySelector('.header');
        const navbar = document.querySelector('.navbar');
        const main = document.querySelector('.main');
          
        if (header && navbar) {
          // è®“ navbar ç·Šè²¼ header åº•éƒ¨
          const headerRect = header.getBoundingClientRect();
          const headerBottom = headerRect.top + headerRect.height;
          navbar.style.top = headerBottom + 'px';
        }
          
        if (navbar && main) {
          // è®“ main ç·Šè²¼ navbar åº•éƒ¨
          const navbarRect = navbar.getBoundingClientRect();
          const navbarBottom = navbarRect.top + navbarRect.height;
          main.style.top = navbarBottom + 'px';
        }
      }

      // é é¢è¼‰å…¥å¾Œèª¿æ•´
      window.addEventListener('load', adjustPositions);

      // è¦–çª—å¤§å°æ”¹è®Šæ™‚èª¿æ•´
      window.addEventListener('resize', adjustPositions);

      // ä½¿ç”¨ ResizeObserver ç›£è½ header å’Œ navbar é«˜åº¦è®ŠåŒ–
      const header = document.querySelector('.header');
      const navbar = document.querySelector('.navbar');

      if (header) {
        const headerObserver = new ResizeObserver(adjustPositions);
        headerObserver.observe(header);
      }

      if (navbar) {
        const navbarObserver = new ResizeObserver(adjustPositions);
        navbarObserver.observe(navbar);
      }
    </script>

  </body>
</html>