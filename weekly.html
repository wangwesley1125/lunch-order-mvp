<!DOCTYPE html>
<html lang = "zh-TW">

    <!-- ä¸æœƒé¡¯ç¤ºæ–¼ç¶²é ç€è¦½è€…çœ¼å‰çš„ -->
  <head>
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ± - æœ¬é€±èœå–®</title>
    <link rel="stylesheet" href="style.css">
  </head>

  <!-- æ‰€æœ‰æœƒé¡¯ç¤ºæ–¼ç¶²é ç€è¦½è€…çœ¼å‰çš„å…§å®¹ -->
  <body>

    <!-- Header -->
    <div class = "header">
      <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
      <p>ä½ çš„åˆé¤æ•‘æ˜Ÿ ğŸŒŸ</p>
    </div>

    <!-- Navigation Bar -->
    <div class = "navbar">
      <a href="index.html">ğŸ—³ï¸ æŠ•ç¥¨ä¸­</a>
      <a href="weekly.html" class="active">ğŸ“… æœ¬é€±åƒä»€éº¼</a>
      <a href="restaurants.html">ğŸª ä¾¿ç•¶åº—å®¶</a>
      <a href="add_restaurants.html"> â• æ–°å¢åº—å®¶</a>
    </div>

    <!-- Main Content -->
    <div class = "main">
      <div id="loading" class="loading">
        è¼‰å…¥èœå–®ä¸­...
      </div>

      <div class="weeks-wrapper" id="weeksWrapper" style="display: none;">
        <!-- æ¯éš”å…©å‘¨æ¸…é™¤è³‡æ–™-->
        <div>
          <p style="font-size: 0.9rem; color: #555; text-align: center; margin-bottom: 20px;">
            æ¯éš”å…©é€±ï¼Œç³»çµ±æœƒè‡ªå‹•æ¸…é™¤æœ¬é€±èˆ‡ä¸‹é€±çš„èœå–®è³‡æ–™ï¼Œè®“å¤§å®¶é‡æ–°æŠ•ç¥¨é¸æ“‡åˆé¤ï¼
          </p>
        </div>
        
        <!-- æœ¬é€± -->
        <div class="week-section">
          <h2 class="week-title">æœ¬é€±èœå–®</h2>
          <div class="week-container" id="thisWeekContainer"></div>
        </div>

        <!-- ä¸‹é€± -->
        <div class="week-section">
          <h2 class="week-title">ä¸‹é€±èœå–®</h2>
          <div class="week-container" id="nextWeekContainer"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class = "footer">
      <p>ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 åˆé¤é»é¤ç³»çµ±</p>
    </div>

    <!-- å¼•å…¥å¤–éƒ¨ JavaScript æª”æ¡ˆ -->
    <!--<script src="script.js"></script>-->

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

      const firebaseConfig = {
          apiKey: "AIzaSyAdo-mbq_BQ5tqY4nvscVNtah24Mb8ohmU",
          authDomain: "realtimevote-f8b6d.firebaseapp.com",
          databaseURL: "https://realtimevote-f8b6d-default-rtdb.firebaseio.com/",
          projectId: "realtimevote-f8b6d",
          storageBucket: "realtimevote-f8b6d.firebasestorage.app",
          messagingSenderId: "44615577610",
          appId: "1:44615577610:web:1bf827f2899ae2550d6ff3",
          measurementId: "G-MW1RJZSC0E"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const weeklyRef = ref(database, 'weekly');
      const votesRef = ref(database, 'votes');
      const restaurantsRef = ref(database, 'restaurants');

      const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

      // å–å¾—æœ¬é€±ä¸€çš„æ—¥æœŸ
      function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = day === 0 ? -6 : 1 - day;
        d.setDate(d.getDate() + diff);
        d.setHours(0, 0, 0, 0);
        return d;
      }

      // å–å¾—æŒ‡å®šé€±çš„æ‰€æœ‰å·¥ä½œæ—¥
      function getWeekDays(mondayDate) {
        const days = [];
        for (let i = 0; i < 5; i++) {
          const date = new Date(mondayDate);
          date.setDate(mondayDate.getDate() + i);
          days.push(date);
        }
        return days;
      }

      // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
      function formatDate(date) {
        return date.toISOString().split('T')[0];
      }

      // å‰µå»ºæ—¥æœŸå¡ç‰‡
      function createDayCard(date, isToday, isPast) {
        const dateStr = formatDate(date);
        const dayOfWeek = date.getDay();
        
        const card = document.createElement('div');
        card.className = 'day-menu';
        if (isToday) card.classList.add('today');
        if (isPast) card.classList.add('past');
        card.setAttribute('data-date', dateStr);

        const header = document.createElement('div');
        header.className = 'day-header';

        const title = document.createElement('h3');
        title.innerHTML = `æ˜ŸæœŸ${dayNames[dayOfWeek]}`;
        if (isToday) {
          title.innerHTML += '<span class="today-indicator"></span>';
        }

        const dateBadge = document.createElement('span');
        dateBadge.className = 'date-badge';
        dateBadge.textContent = `${date.getMonth() + 1}/${date.getDate()}`;

        header.appendChild(title);
        header.appendChild(dateBadge);

        const lunch = document.createElement('p');
        lunch.className = 'selected-lunch no-selection';
        lunch.textContent = 'å°šæœªé¸æ“‡';

        const voteInfo = document.createElement('p');
        voteInfo.className = 'vote-info';

        card.appendChild(header);
        card.appendChild(lunch);
        card.appendChild(voteInfo);

        return card;
      }

      // æ›´æ–°å¡ç‰‡å…§å®¹
      async function updateDayCard(card, dateStr) {
        const lunchElement = card.querySelector('.selected-lunch');
        const voteInfoElement = card.querySelector('.vote-info');

        try {
          // æª¢æŸ¥ weekly è³‡æ–™
          const weeklySnapshot = await get(ref(database, 'weekly'));
          const weeklyData = weeklySnapshot.val();

          // æ‰¾åˆ°å°æ‡‰æ—¥æœŸçš„è¨˜éŒ„
          let foundInWeekly = false;
          if (weeklyData) {
            for (const [day, data] of Object.entries(weeklyData)) {
              if (data.date === dateStr) {
                lunchElement.textContent = `ğŸ± ${data.restaurantName}`;
                lunchElement.classList.remove('no-selection');
                voteInfoElement.textContent = `å¾—ç¥¨æ•¸ï¼š${data.votes} ç¥¨`;
                foundInWeekly = true;
                break;
              }
            }
          }

          // å¦‚æœ weekly æ²’æœ‰ï¼Œæª¢æŸ¥ç•¶å¤©æŠ•ç¥¨çµæœ
          if (!foundInWeekly) {
            const votesSnapshot = await get(ref(database, `votes/${dateStr}`));
            const votes = votesSnapshot.val();

            if (votes) {
              // æ‰¾å‡ºæœ€é«˜ç¥¨
              let maxVotes = 0;
              let winningRestaurant = null;

              for (const [restaurantId, voteCount] of Object.entries(votes)) {
                if (voteCount > maxVotes) {
                  maxVotes = voteCount;
                  winningRestaurant = restaurantId;
                }
              }

              if (winningRestaurant && maxVotes > 0) {
                const restaurantSnapshot = await get(ref(database, `restaurants/${winningRestaurant}`));
                const restaurantData = restaurantSnapshot.val();

                lunchElement.textContent = `ğŸ± ${restaurantData?.name || winningRestaurant}`;
                lunchElement.classList.remove('no-selection');
                voteInfoElement.textContent = `å¾—ç¥¨æ•¸ï¼š${maxVotes} ç¥¨`;
              } else {
                lunchElement.textContent = 'å°šæœªé¸æ“‡';
                lunchElement.classList.add('no-selection');
                voteInfoElement.textContent = '';
              }
            } else {
              lunchElement.textContent = 'å°šæœªé¸æ“‡';
              lunchElement.classList.add('no-selection');
              voteInfoElement.textContent = '';
            }
          }
        } catch (error) {
          console.error('æ›´æ–°å¡ç‰‡å¤±æ•—:', error);
        }
      }

      // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰10å€‹æ ¼å­éƒ½å¡«æ»¿äº†
      async function checkAndClearIfFull() {
        try {
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const thisWeekMonday = getMonday(today);
          const nextWeekMonday = new Date(thisWeekMonday);
          nextWeekMonday.setDate(thisWeekMonday.getDate() + 7);

          const thisWeekDays = getWeekDays(thisWeekMonday);
          const nextWeekDays = getWeekDays(nextWeekMonday);
          const allDays = [...thisWeekDays, ...nextWeekDays];

          // æª¢æŸ¥æ¯ä¸€å¤©æ˜¯å¦éƒ½æœ‰è³‡æ–™
          let filledCount = 0;

          for (const date of allDays) {
            const dateStr = formatDate(date);
            
            // å…ˆæª¢æŸ¥ weekly
            const weeklySnapshot = await get(ref(database, 'weekly'));
            const weeklyData = weeklySnapshot.val();
            
            let hasData = false;
            
            if (weeklyData) {
              for (const [day, data] of Object.entries(weeklyData)) {
                if (data.date === dateStr) {
                  hasData = true;
                  break;
                }
              }
            }
            
            // å¦‚æœ weekly æ²’æœ‰ï¼Œæª¢æŸ¥ votes
            if (!hasData) {
              const votesSnapshot = await get(ref(database, `votes/${dateStr}`));
              const votes = votesSnapshot.val();
              
              if (votes) {
                // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æŠ•ç¥¨
                for (const [restaurantId, voteCount] of Object.entries(votes)) {
                  if (voteCount > 0) {
                    hasData = true;
                    break;
                  }
                }
              }
            }
            
            if (hasData) {
              filledCount++;
            }
          }

          // å¦‚æœæ‰€æœ‰10å€‹æ ¼å­éƒ½å¡«æ»¿äº†ï¼Œæ¸…ç©ºè³‡æ–™
          if (filledCount === 10) {
            console.log('ğŸ‰ æ‰€æœ‰10å€‹æ ¼å­éƒ½å¡«æ»¿äº†ï¼æº–å‚™æ¸…ç©ºè³‡æ–™...');
            
            // æ¸…ç©º weekly è³‡æ–™
            await remove(weeklyRef);
            
            // æ¸…ç©ºæ‰€æœ‰æ—¥æœŸçš„ votes è³‡æ–™
            for (const date of allDays) {
              const dateStr = formatDate(date);
              await remove(ref(database, `votes/${dateStr}`));
              await remove(ref(database, `voters/${dateStr}`));
            }
            
            console.log('âœ… è³‡æ–™å·²æ¸…ç©ºï¼Œç­‰å¾…ä¸‹ä¸€è¼ªï¼');
            
            // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºç©ºç™½ç‹€æ…‹
            setTimeout(() => {
              location.reload();
            }, 1000);
          }
        } catch (error) {
          console.error('æª¢æŸ¥æ¸…ç©ºå¤±æ•—:', error);
        }
      }

      // åˆå§‹åŒ–é é¢
      async function initializePage() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const thisWeekMonday = getMonday(today);
        const nextWeekMonday = new Date(thisWeekMonday);
        nextWeekMonday.setDate(thisWeekMonday.getDate() + 7);

        const thisWeekDays = getWeekDays(thisWeekMonday);
        const nextWeekDays = getWeekDays(nextWeekMonday);

        const thisWeekContainer = document.getElementById('thisWeekContainer');
        const nextWeekContainer = document.getElementById('nextWeekContainer');

        // å‰µå»ºæœ¬é€±å¡ç‰‡
        thisWeekDays.forEach(date => {
          const isToday = formatDate(date) === formatDate(today);
          const isPast = date < today;
          const card = createDayCard(date, isToday, isPast);
          thisWeekContainer.appendChild(card);
        });

        // å‰µå»ºä¸‹é€±å¡ç‰‡
        nextWeekDays.forEach(date => {
          const card = createDayCard(date, false, false);
          nextWeekContainer.appendChild(card);
        });

        // æ›´æ–°æ‰€æœ‰å¡ç‰‡å…§å®¹
        const allCards = document.querySelectorAll('.day-menu');
        for (const card of allCards) {
          const dateStr = card.getAttribute('data-date');
          await updateDayCard(card, dateStr);
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ¸…ç©º
        await checkAndClearIfFull();

        // éš±è—è¼‰å…¥è¨Šæ¯
        document.getElementById('loading').style.display = 'none';
        document.getElementById('weeksWrapper').style.display = 'block';
      }

      // ç›£è½è³‡æ–™è®ŠåŒ–
      onValue(weeklyRef, async () => {
        const allCards = document.querySelectorAll('.day-menu');
        for (const card of allCards) {
          const dateStr = card.getAttribute('data-date');
          await updateDayCard(card, dateStr);
        }
        // æ¯æ¬¡è³‡æ–™è®ŠåŒ–æ™‚æª¢æŸ¥æ˜¯å¦éœ€è¦æ¸…ç©º
        await checkAndClearIfFull();
      });

      onValue(votesRef, async () => {
        const allCards = document.querySelectorAll('.day-menu');
        for (const card of allCards) {
          const dateStr = card.getAttribute('data-date');
          await updateDayCard(card, dateStr);
        }
        // æ¯æ¬¡è³‡æ–™è®ŠåŒ–æ™‚æª¢æŸ¥æ˜¯å¦éœ€è¦æ¸…ç©º
        await checkAndClearIfFull();
      });

      // åˆå§‹åŒ–
      initializePage();

      // å‹•æ…‹èª¿æ•´ä½ç½®
      function adjustPositions() {
        const header = document.querySelector('.header');
        const navbar = document.querySelector('.navbar');
        const main = document.querySelector('.main');
        
        if (header && navbar) {
          const headerRect = header.getBoundingClientRect();
          navbar.style.top = headerRect.bottom + 'px';
        }
        
        if (navbar && main) {
          const navbarRect = navbar.getBoundingClientRect();
          main.style.top = navbarRect.bottom + 'px';
        }
      }

      window.addEventListener('load', adjustPositions);
      window.addEventListener('resize', adjustPositions);

      const header = document.querySelector('.header');
      const navbar = document.querySelector('.navbar');

      if (header) {
        const headerObserver = new ResizeObserver(adjustPositions);
        headerObserver.observe(header);
      }

      if (navbar) {
        const navbarObserver = new ResizeObserver(adjustPositions);
        navbarObserver.observe(navbar);
      }
    </script>

  </body>

</html>